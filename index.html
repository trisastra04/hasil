<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapitulasi Pemilihan Ketua dan Wakil Ketua OSIS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Plugin untuk menampilkan label di dalam chart -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* CSS untuk background gambar sekolah */
        .app-background {
            background-image: linear-gradient(rgba(243, 244, 246, 0.92), rgba(243, 244, 246, 0.92)), url('images/background-sekolah.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* CSS overlay background untuk dark mode */
        .dark .app-background {
            background-image: linear-gradient(rgba(17, 24, 39, 0.95), rgba(17, 24, 39, 0.95)), url('images/background-sekolah.jpg');
        }

        /* Menghilangkan efek pemenang */
        .candidate-card {
            transition: transform 0.3s ease-in-out;
        }
        .candidate-card:hover {
            transform: scale(1.03);
        }

        #voteChart {
            max-height: 400px;
            cursor: pointer;
        }
        
        #close-modal-btn {
            font-size: 2rem;
            line-height: 1;
        }

        /* CSS UNTUK ANIMASI RUNNING TEXT BARU */
        .running-text-content {
            animation: marquee 50s linear infinite;
            display: inline-block;
        }

        @keyframes marquee {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
    </style>
</head>
<body class="app-background text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8 relative">
        <!-- Password Section -->
        <div id="password-section" class="absolute top-4 right-4 z-20">
            <div class="flex items-center space-x-2 bg-white/80 dark:bg-gray-800/80 p-2 rounded-lg shadow">
                <input type="password" id="password-input" placeholder="Password" class="bg-transparent text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-amber-500 focus:border-amber-500 outline-none w-28 px-2 py-1">
                <button id="password-submit" class="bg-amber-600 hover:bg-amber-700 text-white text-sm font-bold p-1.5 rounded transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <header class="mb-8">
            <div class="flex justify-center items-center space-x-4 sm:space-x-6">
                <img src="images/logo-sekolah.png" alt="Logo Sekolah" class="h-16 sm:h-20 md:h-24 object-contain">
                <div class="text-center">
                    <h1 class="text-xl sm:text-3xl md:text-4xl font-bold text-gray-900 dark:text-white">Rekapitulasi Hasil Pemilihan</h1>
                    <p class="text-sm sm:text-lg md:text-xl text-blue-600 dark:text-blue-400">Ketua & Wakil Ketua OSIS SMA Unggul Islam Al-Fahd</p>
                </div>
                <img src="images/logo-osis.png" alt="Logo OSIS" class="h-16 sm:h-20 md:h-24 object-contain">
            </div>
        </header>

        <!-- Top Stats Wrapper -->
        <div id="top-stats-wrapper" class="hidden max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
                <!-- Total Votes Container -->
                <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Total Suara Masuk</h2>
                    <p id="total-votes-display" class="text-6xl font-extrabold text-blue-600 dark:text-blue-400 my-2">0</p>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-sync-alt fa-spin mr-1"></i>
                        <span id="last-updated">Diperbarui...</span>
                    </div>
                </div>
                <!-- Total Registered Voters Container -->
                <div class="text-center p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white">Total Pemilih Ditetapkan</h2>
                    <p class="text-6xl font-extrabold text-green-600 dark:text-green-400 my-2">229</p>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-users mr-1"></i>
                        <span>Daftar Pemilih Tetap (DPT)</span>
                    </div>
                </div>
            </div>
            
            <!-- Voter Stats per Class Container -->
            <div class="p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white text-center mb-4">Statistik Kehadiran Pemilih</h2>
                <div class="relative h-56">
                    <canvas id="voterTurnoutChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Running Text Container -->
        <div id="running-text-container" class="hidden max-w-7xl mx-auto mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-2 overflow-hidden whitespace-nowrap">
                <div class="running-text-content">
                    <!-- Content Block 1 -->
                    <span class="inline-flex items-center">
                        <img src="images/logo-sekolah.png" alt="Logo Sekolah" class="h-6 w-auto mx-4">
                        <span class="text-lg font-semibold text-amber-600 dark:text-amber-500">
                            Gunakan hak pilih Anda dengan bijak! Suara Anda menentukan masa depan OSIS SMA Unggul Islam Al-Fahd. Pemilihan yang Jujur, Adil, dan Transparan.
                        </span>
                        <img src="images/logo-osis.png" alt="Logo OSIS" class="h-6 w-auto mx-4">
                    </span>
                    <!-- Content Block 2 (Duplicate for seamless loop) -->
                     <span class="inline-flex items-center">
                        <img src="images/logo-sekolah.png" alt="Logo Sekolah" class="h-6 w-auto mx-4">
                        <span class="text-lg font-semibold text-amber-600 dark:text-amber-500">
                            Gunakan hak pilih Anda dengan bijak! Suara Anda menentukan masa depan OSIS SMA Unggul Islam Al-Fahd. Pemilihan yang Jujur, Adil, dan Transparan.
                        </span>
                        <img src="images/logo-osis.png" alt="Logo OSIS" class="h-6 w-auto mx-4">
                    </span>
                </div>
            </div>
        </div>


        <!-- Loading / Error Indicator -->
        <div id="status-indicator" class="text-center py-10">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-lg">Mengambil data suara terbaru...</p>
        </div>

        <!-- Candidates Container -->
        <main id="candidates-container" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <!-- Candidate cards will be dynamically inserted here -->
        </main>
        
        <!-- Chart Container -->
        <div id="summary-container" class="hidden">
            <div class="max-w-4xl mx-auto bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                 <h2 class="text-2xl font-bold text-center mb-4 text-gray-900 dark:text-white">Diagram Perolehan Suara</h2>
                <canvas id="voteChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal for Detailed Stats -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 transition-opacity duration-300">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6 relative transform transition-all duration-300 scale-95 opacity-0" id="modal-box">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-gray-400 hover:text-gray-800 dark:hover:text-white">&times;</button>
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">Detail Perolehan Suara</h3>
            <div id="modal-content" class="text-left text-gray-700 dark:text-gray-300">
                <!-- Content will be injected by JavaScript -->
            </div>
        </div>
    </div>


    <script type="module">
        // --- KONFIGURASI ---
        const VOTE_DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pUh4kIJI6xfQXlndQ5m5hXgU-1bzctmmhsbcaLmTMfHcq0rk4j73hRNpPRLtctfNG_ngQeEQcrj-/pub?gid=1604938357&single=true&output=csv';
        const PASSWORD_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7pUh4kIJI6xfQXlndQ5m5hXgU-1bzctmmhsbcaLmTMfHcq0rk4j73hRNpPRLtctfNG_ngQeEQcrj-/pub?gid=1346986434&single=true&output=csv';
        const REFRESH_INTERVAL = 60000; // Interval diubah menjadi 1 menit (60 detik)
        
        // --- DATA JUMLAH PEMILIH PER KELAS (STATIS) ---
        const TOTAL_VOTERS_DATA = new Map([
            ['X 1', 19], ['X 2', 19], ['X 3', 24], ['X 4', 23],
            ['XI 1', 23], ['XI 2', 25], ['XI 3', 29],
            ['XII 1', 22], ['XII 2', 17],
            ['Guru dan Tendik', 28]
        ]);

        // --- DATA KANDIDAT ---
        const candidates = [
            { id: 'kandidat_1', number: '01', ketua: 'NHEYRINDA AFRILIAN', wakil: 'NAZILAH MENTARI HARYAN', csvName: 'NHEYRINDA AFRILIAN', photo: 'images/paslon1.png' },
            { id: 'kandidat_2', number: '02', ketua: 'IHDA NURDIANA EFELYN', wakil: 'BALQIS NADHIRAH SAKHIYAH', csvName: 'IHDA NURDIANA EFELYN', photo: 'images/paslon2.png' },
            { id: 'kandidat_3', number: '03', ketua: 'RACHMAD AIDIEL ADHA', wakil: 'NANDANA RAKHA DANISWARA', csvName: 'RACHMAD AIDIEL ADHA', photo: 'images/paslon3.png' },
            { id: 'kandidat_4', number: '04', ketua: 'GILANG AKBAR PRAYOGA', wakil: 'MUHAMMAD HARU SALAM', csvName: 'GILANG AKBAR PRAYOGA', photo: 'images/paslon4.png' }
        ];
        const chartColors = ['#3498db', '#2ecc71', '#e74c3c', '#9b59b6'];

        // --- ELEMENT REFERENCES ---
        const statusIndicatorEl = document.getElementById('status-indicator');
        const topStatsWrapperEl = document.getElementById('top-stats-wrapper');
        const runningTextContainerEl = document.getElementById('running-text-container');
        const candidatesContainerEl = document.getElementById('candidates-container');
        const summaryContainerEl = document.getElementById('summary-container');
        const totalVotesDisplayEl = document.getElementById('total-votes-display');
        const lastUpdatedEl = document.getElementById('last-updated');
        const detailModalEl = document.getElementById('detail-modal');
        const modalBoxEl = document.getElementById('modal-box');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitleEl = document.getElementById('modal-title');
        const modalContentEl = document.getElementById('modal-content');
        const passwordSection = document.getElementById('password-section');
        const passwordInput = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit');
        
        let voteChart = null;
        let turnoutChart = null;
        let resultsUnlocked = false;
        let correctPassword = '';

        function setupUI() {
            candidatesContainerEl.innerHTML = '';
            candidates.forEach(candidate => {
                const cardHTML = `
                    <div id="card-${candidate.id}" class="candidate-card bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 text-center flex flex-col justify-between items-center h-[480px] md:h-[520px]">
                        <img src="${candidate.photo}" alt="Foto ${candidate.ketua}" class="w-[65%] aspect-[9/16] object-cover rounded-lg shadow-md">
                        <div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-1">${candidate.ketua}</h3>
                            <p class="text-md text-amber-600 dark:text-amber-500 font-medium">${candidate.wakil}</p>
                            <p class="vote-count-display hidden text-4xl font-bold text-blue-500 dark:text-blue-400 mt-4" id="votes-${candidate.id}">0</p>
                            <p class="vote-label text-lg text-gray-500 dark:text-gray-400">Suara</p>
                        </div>
                    </div>
                `;
                candidatesContainerEl.innerHTML += cardHTML;
            });
            initializeChart();
            initializeTurnoutChart();
        }

        function initializeChart() {
            Chart.register(ChartDataLabels);
            const ctx = document.getElementById('voteChart').getContext('2d');
            voteChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: candidates.map(c => `${c.ketua} & ${c.wakil}`),
                    datasets: [{
                        label: 'Perolehan Suara',
                        data: candidates.map(() => 0),
                        backgroundColor: chartColors,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        detailedStats: []
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: document.body.classList.contains('dark') ? '#FFF' : '#333' } },
                        tooltip: { enabled: false },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                const percentage = sum > 0 ? (value / sum * 100) : 0;
                                if (percentage < 5) return '';
                                const firstName = candidates[ctx.dataIndex].ketua.split(' ')[0];
                                return `${firstName}\n${percentage.toFixed(1)}%`;
                            },
                            color: '#fff', textAlign: 'center', font: { weight: 'bold', size: 12 },
                            textStrokeColor: 'rgba(0,0,0,0.5)', textStrokeWidth: 2
                        }
                    }
                }
            });

            // PERBAIKAN: Menambahkan event listener langsung ke canvas
            ctx.canvas.onclick = (event) => {
                const elements = voteChart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (elements.length) {
                    const dataIndex = elements[0].index;
                    const candidateName = voteChart.data.labels[dataIndex];
                    const detailedStats = voteChart.data.datasets[0].detailedStats[dataIndex];
                    if (detailedStats) {
                        showDetailModal(candidateName, detailedStats);
                    }
                }
            };
        }
        
        function initializeTurnoutChart() {
            const ctx = document.getElementById('voterTurnoutChart').getContext('2d');
            turnoutChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Sudah Memilih', data: [], backgroundColor: '#f59e0b' },
                        { label: 'Belum Memilih', data: [], backgroundColor: '#e5e7eb' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: document.body.classList.contains('dark') ? '#FFF' : '#333', font: { weight: 'bold' } } },
                        y: { stacked: true, beginAtZero: true, ticks: { color: document.body.classList.contains('dark') ? '#FFF' : '#333', font: { weight: 'bold' } } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#FFF' : '#333', font: { weight: 'bold' } } },
                        tooltip: { mode: 'index' }
                    }
                }
            });
        }
        
        async function fetchPassword() {
            try {
                const response = await fetch(`${PASSWORD_CSV_URL}&t=${new Date().getTime()}`, { method: 'GET', redirect: 'follow' });
                if (!response.ok) throw new Error('Gagal mengambil password');
                const csvText = await response.text();
                const rows = csvText.split(/\r?\n/).slice(1);
                if (rows.length > 0 && rows[0].trim()) {
                    correctPassword = rows[0].split(',')[0].trim();
                }
            } catch (error) {
                console.error("Error fetching password:", error);
                passwordInput.placeholder = "Error PW";
                passwordInput.disabled = true;
                passwordSubmitBtn.disabled = true;
            }
        }

        async function fetchAndProcessData() {
            try {
                const voteResponse = await fetch(`${VOTE_DATA_CSV_URL}&t=${new Date().getTime()}`, { method: 'GET', redirect: 'follow' });
                if (!voteResponse.ok) throw new Error(`Gagal mengambil data suara: ${voteResponse.statusText}`);
                const csvText = await voteResponse.text();

                const rows = csvText.split(/\r?\n/).slice(1).filter(row => row.trim() !== '');
                const allVoteData = rows.map(row => {
                    const columns = row.split(',');
                    let choice = (columns[2] || "").trim().replace(/"/g, '');
                    const candidateId = parseInt(choice, 10);
                    if (!isNaN(candidateId)) {
                        const foundCandidate = candidates.find(c => c.number === `0${candidateId}` || c.number === `${candidateId}`);
                        if (foundCandidate) choice = foundCandidate.csvName;
                    }
                    return { choice, class: (columns[3] || "").trim().replace(/"/g, '') };
                }).filter(v => v.choice && v.class);

                updateDisplay(allVoteData, TOTAL_VOTERS_DATA);

                statusIndicatorEl.classList.add('hidden');
                topStatsWrapperEl.classList.remove('hidden');
                runningTextContainerEl.classList.remove('hidden');
                candidatesContainerEl.classList.remove('hidden');
                if (resultsUnlocked) {
                    summaryContainerEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error fetching data:", error);
                statusIndicatorEl.innerHTML = `
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
                    <p class="mt-4 text-lg text-red-500">Gagal memuat data. Pastikan link CSV benar. Error: ${error.message}</p>
                `;
            }
        }
        
        function updateDisplay(allVoteData, totalVotersByClass) {
            const voteStats = {};
            candidates.forEach(c => { voteStats[c.csvName] = { total: 0, byClass: {} }; });
            
            const votesByClass = {};
            allVoteData.forEach(vote => {
                if (voteStats.hasOwnProperty(vote.choice)) {
                    voteStats[vote.choice].total++;
                    const className = vote.class;
                    if (!voteStats[vote.choice].byClass[className]) {
                        voteStats[vote.choice].byClass[className] = 0;
                    }
                    voteStats[vote.choice].byClass[className]++;
                }
                if (!votesByClass[vote.class]) votesByClass[vote.class] = 0;
                votesByClass[vote.class]++;
            });

            if (turnoutChart) {
                const allClassNames = new Set([...totalVotersByClass.keys(), ...Object.keys(votesByClass)]);
                const sortedClasses = Array.from(allClassNames).sort();
                
                const votedData = []; const notVotedData = [];
                for (const className of sortedClasses) {
                    const total = totalVotersByClass.get(className) || (votesByClass[className] || 0);
                    const voted = votesByClass[className] || 0;
                    notVotedData.push(total - voted);
                    votedData.push(voted);
                }
                turnoutChart.data.labels = sortedClasses;
                turnoutChart.data.datasets[0].data = votedData;
                turnoutChart.data.datasets[1].data = notVotedData;
                turnoutChart.update();
            }

            totalVotesDisplayEl.textContent = allVoteData.length;
            
            candidates.forEach(candidate => {
                const votes = voteStats[candidate.csvName].total || 0;
                document.getElementById(`votes-${candidate.id}`).textContent = votes;
            });
            
            if(voteChart) {
                voteChart.data.datasets[0].data = candidates.map(c => voteStats[c.csvName].total || 0);
                voteChart.data.datasets[0].detailedStats = candidates.map(c => voteStats[c.csvName]);
                voteChart.update();
            }

            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            lastUpdatedEl.textContent = `Diperbarui ${new Intl.DateTimeFormat('id-ID', options).format(now).replace(/\./g, ':')} WIB`;
            document.querySelectorAll('.vote-label').forEach(el => {
                el.classList.toggle('hidden', !resultsUnlocked);
            });
        }
        
        function showDetailModal(candidateName, stats) {
            modalTitleEl.textContent = `Detail Suara: ${candidateName.split(' & ')[0]}`;
            if (!stats || stats.total === 0) {
                modalContentEl.innerHTML = `<p class="text-gray-600 dark:text-gray-400">Belum ada suara.</p>`;
            } else {
                const classBreakdown = stats.byClass;
                const candidateTotal = stats.total;
                let contentHTML = `<p class="mb-4 text-lg">Total Diperoleh: <span class="font-bold text-blue-500">${candidateTotal}</span></p>`;
                contentHTML += `<h4 class="font-semibold mb-2 text-gray-800 dark:text-gray-200">Rincian per Kelas:</h4>`;
                contentHTML += `<ul class="space-y-2 max-h-60 overflow-y-auto pr-2">`;
                const sortedClasses = Object.entries(classBreakdown).sort(([, a], [, b]) => b - a);
                sortedClasses.forEach(([className, count]) => {
                    const percentage = ((count / candidateTotal) * 100).toFixed(1);
                    contentHTML += `
                        <li class="flex justify-between items-center py-1 border-b border-gray-200 dark:border-gray-700">
                            <span>${className}</span>
                            <span class="font-semibold text-right">${count} suara<br><span class="text-xs text-gray-500">(${percentage}%)</span></span>
                        </li>`;
                });
                contentHTML += `</ul>`;
                modalContentEl.innerHTML = contentHTML;
            }
            detailModalEl.classList.remove('hidden');
            setTimeout(() => { modalBoxEl.classList.remove('scale-95', 'opacity-0'); }, 10);
        }
        function hideDetailModal() {
            modalBoxEl.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { detailModalEl.classList.add('hidden'); }, 300);
        }
        // --- Event Listeners ---
        closeModalBtn.addEventListener('click', hideDetailModal);
        detailModalEl.addEventListener('click', (event) => {
            if (event.target === detailModalEl) hideDetailModal();
        });
        passwordSubmitBtn.addEventListener('click', () => {
            if (passwordInput.value === correctPassword && correctPassword !== '') {
                resultsUnlocked = true;
                passwordSection.classList.add('hidden');
                document.querySelectorAll('.vote-count-display, .vote-label').forEach(el => el.classList.remove('hidden'));
                summaryContainerEl.classList.remove('hidden');
            } else {
                passwordInput.value = '';
                passwordInput.placeholder = 'Password Salah!';
                passwordInput.classList.add('border-red-500', 'placeholder-red-500');
                setTimeout(() => {
                    passwordInput.placeholder = 'Password';
                    passwordInput.classList.remove('border-red-500', 'placeholder-red-500');
                }, 2000);
            }
        });
        
        passwordInput.addEventListener('keypress', (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                passwordSubmitBtn.click();
            }
        });
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchPassword();
            setupUI();
            fetchAndProcessData();
            setInterval(fetchAndProcessData, REFRESH_INTERVAL);
        });
    </script>
</body>
</html>

